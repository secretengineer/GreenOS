rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user has access to greenhouse
    function hasGreenhouseAccess(greenhouseId) {
      return request.auth != null && 
             request.auth.uid in get(/databases/$(database)/documents/greenhouses/$(greenhouseId)).data.users;
    }
    
    // Helper function to check if request is from an authorized device
    function isAuthorizedDevice(greenhouseId) {
      return request.auth != null && 
             request.auth.token.isDevice == true &&
             request.auth.token.greenhouseId == greenhouseId;
    }
    
    // Devices collection (for device registration)
    match /devices/{deviceId} {
      // Only admins can read/write device registrations
      allow read, write: if request.auth != null && 
                            request.auth.token.admin == true;
    }
    
    // Greenhouses collection
    match /greenhouses/{greenhouseId} {
      // Users can read/write greenhouses they belong to
      allow read, write: if request.auth != null && 
                            request.auth.uid in resource.data.users;
      
      // Sensor data subcollection
      match /sensors/{sensorId} {
        allow read: if hasGreenhouseAccess(greenhouseId);
        // Only allow writes from authorized devices for this greenhouse
        allow write: if isAuthorizedDevice(greenhouseId);
      }
      
      // Alerts subcollection
      match /alerts/{alertId} {
        allow read: if hasGreenhouseAccess(greenhouseId);
        // Users can acknowledge alerts, only Cloud Functions can create them
        allow update: if hasGreenhouseAccess(greenhouseId) && 
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['acknowledged', 'acknowledgedBy', 'acknowledgedAt']);
        allow create, delete: if false; // Only Cloud Functions can create/delete alerts
      }
      
      // Commands subcollection
      match /commands/{commandId} {
        allow read: if hasGreenhouseAccess(greenhouseId);
        allow create: if hasGreenhouseAccess(greenhouseId);
        allow update, delete: if false; // Commands are immutable after creation
      }
      
      // Logs subcollection
      match /logs/{logId} {
        allow read: if hasGreenhouseAccess(greenhouseId);
        allow write: if false; // Only Cloud Functions can write logs
      }
      
      // Daily summaries subcollection
      match /daily_summaries/{summaryId} {
        allow read: if hasGreenhouseAccess(greenhouseId);
        allow write: if false; // Only functions can write summaries
      }
      
      // Weather data subcollection
      match /weather/{weatherId} {
        allow read: if hasGreenhouseAccess(greenhouseId);
        allow write: if false; // Only functions can write weather data
      }
    }
    
    // Users collection (for profile data)
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
